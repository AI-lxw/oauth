<html>
    <head>
        <link rel="stylesheet" href="/static/css/bulma.min.css">
        <style>
            body{
                height: 100%;
                color: white!important;
                overflow-y: auto;
            }
            .title{
                color:white!important;
            }
            .label{
                color: whitesmoke!important;
            }
            .bg{
                background-image: url("/static/images/bg.png") !important;
                background-repeat: repeat-x!important;
            }
            .table td, .table th{
                vertical-align: middle !important;
            }
            .special-form>.field-label{
                flex: none;
            }
            .special-form .field-body>.field{
                flex-grow: 0 !important;
            }
        </style>
         <title>OpenAuth 应用用户管理</title>
    </head>
    <body class="bg">
        <div class="columns">
            <div class="column"></div>
            <div class="column is-three-quarters">
                <h2 style="text-align: center;"  class="title is-2"> 当前应用:{{.App.Name}}</h2>
                <div class="buttons">
                    <a class="button is-white" href="/">首页</a>
                    <button class="button is-info" onclick="runMode('black')">黑名单模式运行</button>
                    <button class="button is-warning" onclick="runMode('white')">白名单模式运行</button>
                    <a class="button is-success" href="/app/{{.App.ID}}/user_manager/role">角色与权限</a>
                </div>
                <hr>
                <div class="field is-horizontal special-form">
                    <div class="field-label is-normal">
                        <label class="label">用户:</label>
                    </div>
                    <div class="field-body">
                        <div class="field">
                            <p class="control">
                                <input class="input" type="text" id="username">
                            </p>
                        </div>
                        <div class="field">
                            <div class="select">
                                <select id="category">
                                    <option value="white">白名单</option>
                                    <option value="black">黑名单</option>
                                </select>
                            </div>
                        </div>
                        <div class="field">
                            <button class="button is-success" onclick="addUser2CategoryList()">添加</button>
                        </div>
                    </div>
                </div>
                <hr>
                <h3 class="title is-3">白名单列表:</h3>
                <table class="table is-striped is-hoverable  is-fullwidth">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>角色</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .WhiteList}}
                            <tr>
                                <td>{{.User.Name}}</td>
                                <td>{{.AppUserList.RoleID}}</td>
                                <td>
                                    <div class="buttons">
                                        <button class="button is-small" onclick="deleteFromUserList({{.AppUserList.ID}}, {{.User.Name}})">删除</button>
                                    </div>
                                </td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
                <hr>
                <h3 class="title is-3">黑名单列表:</h3>
                <table class="table is-striped is-hoverable  is-fullwidth">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .BlackList}}
                        <tr>
                            <td>{{.User.Name}}</td>
                            <td>
                                <div class="buttons">
                                    <button class="button is-small" onclick="deleteFromUserList({{.AppUserList.ID}}, {{.User.Name}})">删除</button>
                                </div>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div class="column"></div>
        </div>
    </body>
    <script>
        var appID = {{.App.ID}};
        var clientID = "{{.App.ClientID}}";
        function $(id){
            return document.querySelector(id)
        }

        function addUser2CategoryList(){
            let username = $("#username").value
            let category = $("#category").value
            fetch(`/api/app/${appID}/user_manager`,{
                method: 'POST',
                headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({username: username, category: category})
            }).then((resp)=>{
                if(resp.status == 200){
                    confirm("添加成功!")
                    window.reload()
                }else{
                    confirm(resp.statusText)
                }
            });
        }

        function deleteFromUserList(id, name){
            if(!confirm("是否删除用户:"+name)){
                return
            }
            fetch(`/api/app/${appID}/user_manager/`+id, {
                method:"DELETE"
            }).then((resp)=>{
                if(resp.status == 200){
                    location.reload()
                    return
                }
                resp.text().then((t)=>{
                    confirm(resp.status + ":"+t)
                })
            })
        }

        function runMode(mode){
            fetch(`/api/app/${appID}/user_mode/${mode}`,{
                method:"PATCH"
            }).then((resp)=>{
                if(resp.status == 200){
                    confirm("修改成功!")
                    return
                }
                resp.text().then((t)=>{
                    confirm(resp.status + ":"+t)
                })
                
            })
        }
    </script>
</html>