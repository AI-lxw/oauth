<html>
    <head>
        <link rel="stylesheet" href="/static/css/bulma.min.css">
        <style>
            body{
                height: 100%;
                color: white!important;
                overflow-y: auto;
            }
            .title{
                color:white!important;
            }
            .label{
                color: whitesmoke!important;
            }
            .bg{
                background-image: url("/static/images/bg.png") !important;
                background-repeat: repeat-x!important;
            }
            .table td, .table th{
                vertical-align: middle !important;
            }
            .special-form>.field-label{
                flex: none;
            }
            .special-form .field-body>.field{
                flex-grow: 0 !important;
            }
        </style>
         <title>OpenAuth 应用角色权限管理</title>
    </head>
    <body class="bg">
        <div class="columns">
            <div class="column"></div>
            <div class="column is-three-quarters">
                <h2 style="text-align: center;"  class="title is-2"> 当前应用:{{.App.Name}} - {{.Role.Name}}</h2>
                <div class="buttons">
                    <a class="button is-white" href="/">首页</a>
                    <a class="button is-success">角色与权限</a>
                </div>
                <hr>
                <div class="field is-horizontal">
                    <div class="field-label is-normal">
                        <label class="label">权限:</label>
                    </div>
                    <div class="field-body">
                        <div class="field">
                            <p class="control">
                                <input class="input" type="text" id="pattern" placeholder="url正则">
                            </p>
                        </div>
                        <div class="field">
                            <p class="control">
                                <input class="input" type="text" id="method" placeholder="HTTP Method">
                            </p>
                        </div>
                        <div class="field">
                            <p class="control">
                                <input class="input" type="text" id="name" placeholder="备注">
                            </p>
                        </div>
                        <div class="field">
                            <button class="button is-success" onclick="addRole()">添加</button>
                        </div>
                    </div>
                </div>
                <hr>
                <h3 class="title is-3">权限列表:</h3>
                <table class="table is-striped is-hoverable  is-fullwidth">
                    <thead>
                        <tr>
                            <th>权限</th>
                            <th>HTTP Method</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{$app := .App}}
                        {{range .PermissionList}}
                            <tr>
                                <td>{{.Pattern}}</td>
                                <td>{{.Method}}</td>
                                <td>{{.Name}}</td>
                                <td>
                                    <div class="buttons">
                                        <button class="button is-small" onclick="delPermission({{.ID}}, {{.Name}})">删除</button>
                                    </div>
                                </td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div class="column"></div>
        </div>
    </body>
    <script>
        var appID = {{.App.ID}};
        var roleID = {{.Role.ID}};
        var clientID = "{{.App.ClientID}}";
        function $(id){
            return document.querySelector(id)
        }

        function addRole(){
            let pattern = $("#pattern").value
            let httpMethod = $("#method").value
            let name = $("#name").value
            console.log(name, pattern, httpMethod)
            fetch(`/api/app/${appID}/role/${roleID}/permission`,{
                method: 'POST',
                headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({name: name, pattern: pattern, method: httpMethod})
            }).then((resp)=>{
                if(resp.status == 200){
                    confirm("添加成功!")
                    location.reload()
                }else{
                    confirm(resp.statusText)
                }
            });
        }

        function delPermission(id, name){
            if(!confirm("是否删除权限:"+name)){
                return
            }
            fetch(`/api/app/${appID}/role/${roleID}/permission/${id}`, {
                method:"DELETE"
            }).then((resp)=>{
                if(resp.status == 200){
                    location.reload()
                    return
                }
                resp.text().then((t)=>{
                    confirm(resp.status + ":"+t)
                })
            })
        }

    </script>
</html>